{% extends 'base_users.html' %}
{% load static doc_labels %}
{% block title %}Panel Acudiente{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/panel_acudiente.css' %}?v=7">
<script defer src="{% static 'js/carousel_acudiente_native.js' %}?v=1"></script>
{% endblock %}
{% block content %}
  <div class="center" style="margin:20px 0 8px;">
    {% if acudiente %}
      <h2 style="margin:0;font-weight:700;">Hola {{ acudiente.id_usu.nom_usu }} {{ acudiente.id_usu.ape_usu }}</h2>
    {% else %}
      <h2 style="margin:0;font-weight:700;">Hola</h2>
    {% endif %}
  </div>

  <!-- Barra de búsqueda -->
  <div class="search-wrap">
    <input id="inst-search" class="search-input" type="search" placeholder="Busca una institución..." aria-label="Buscar institución">
    <div class="search-btn" aria-hidden="true" style="pointer-events:none;opacity:.6;">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"></path></svg>
    </div>
  </div>
  <div id="inst-results"></div>

  <!-- Carrusel instituciones sugeridas -->
  <section class="testimonial-section" aria-label="Instituciones sugeridas">
    <div class="testimonial-head">
      <h2>Instituciones que te pueden interesar</h2>
    </div>
    <div class="testimonial-viewport">
    <div class="testimonial-carousel" role="list" id="suggested-carousel">
      {% for inst in suggested_instituciones %}
        {% with cursos=inst.cursos_list %}
        {% regroup cursos by id_inst as curso_list %}
        <article class="testimonial-item" role="listitem" data-inst-id="{{ inst.id_inst }}" data-inst-name="{{ inst.nom_inst }}" data-grades="[{% for c in cursos %}{% with g=c.grd_cur|default:'' %}{% if g %}{% if not forloop.first %},{% endif %}"{{ g|cut:'º' }}"{% endif %}{% endwith %}{% endfor %}]">
          <div class="ti-top">
            {% if inst.img_inst %}
              <img src="{{ inst.img_inst.url }}" alt="{{ inst.nom_inst }}">
            {% else %}
              <img src="{% static 'img/default_inst.png' %}" alt="{{ inst.nom_inst }}">
            {% endif %}
            <div class="ti-texts">
              <h3 class="ti-name">{{ inst.nom_inst }}</h3>
              <p class="ti-role">{{ inst.tip_inst|default:'Institución' }}</p>
            </div>
          </div>
          <p>{{ inst.dire_inst|default:'Sin dirección' }}</p>
          <a href="#" class="testimonial-matricular" data-action="matricular" data-inst-id="{{ inst.id_inst }}">Matricular</a>
        </article>
        {% endwith %}
      {% empty %}
        <article class="testimonial-item" role="listitem"><p>No hay instituciones registradas aún.</p></article>
      {% endfor %}
    </div>
    </div>
    <div class="testimonial-dots" role="tablist" aria-label="Paginación">
      {% for p in carousel_range %}
        <button class="owl-dot{% if forloop.first %} active{% endif %}" aria-label="Grupo {{ forloop.counter }}"></button>
      {% endfor %}
    </div>
  </section>

  <!-- Modal matrícula -->
  <div id="mat-modal">
    <div class="modal-box">
      <h3 id="mat-modal-title">Solicitar matrícula</h3>
      <p id="mat-modal-inst" style="margin:6px 0 12px 0;color:#444"></p>
      <label for="mat-modal-grado">Elegir grado</label>
      <select id="mat-modal-grado"></select>
      <label for="mat-modal-est">Seleccionar estudiante</label>
      <select id="mat-modal-est"></select>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button id="mat-modal-cancel" class="btn secondary" type="button">Cancelar</button>
        <button id="mat-modal-send" class="btn" type="button">Enviar solicitud</button>
      </div>
    </div>
  </div>


  <!-- Lista de estudiantes -->
  <center><p style="margin:6px 0 0;font-weight:600;color:#64748b;text-align:center;">Tus estudiantes</p></center>
  <section class="student-list" aria-label="Estudiantes registrados">
    {% if students_list %}
      {% for item in students_list %}
        {% with est=item.est %}
        <a class="student-item" href="{% url 'accounts:estudiante_detail' est.id_est %}" aria-label="Detalle de {{ est.id_usu.nom_usu }} {{ est.id_usu.ape_usu }}">
          <div class="avatar" aria-hidden="true">
            {% if est.foto_perfil %}<img src="{{ est.foto_perfil.url }}" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:999px;">{% else %}{{ est.id_usu.nom_usu|first }}{{ est.id_usu.ape_usu|first }}{% endif %}
          </div>
          <div class="item-main">
            <div class="item-line">
              <span class="item-name">{{ est.id_usu.nom_usu }} {{ est.id_usu.ape_usu }}</span>
              <span class="item-amount">{% if item.grado_display %}{{ item.grado_display }}{% else %}-{% endif %}</span>
            </div>
            <div class="item-sub">Documento: {{ est.num_doc_est }} • Inst.: {% if item.matricula and item.matricula.id_cur and item.matricula.id_cur.id_inst %}{{ item.matricula.id_cur.id_inst.nom_inst }}{% else %}Sin asignar{% endif %}</div>
            {% if item.matricula %}
              <div class="enrollment-status enrolled">Matriculado</div>
            {% else %}
              <div class="enrollment-status not-enrolled">Sin matrícula</div>
            {% endif %}
            {% if item.documents_complete %}
              <div class="doc-status doc-ok">Documentos completos</div>
            {% else %}
              <div class="doc-status doc-pending">Documentos pendientes</div>
              {% if item.missing %}
                <div class="missing-list">
                  <strong>Faltan:</strong>
                  {% for m in item.missing|slice:':3' %}
                    <span>{{ m|doc_label }}{% if not forloop.last %}, {% endif %}</span>
                  {% endfor %}
                  {% if item.missing|length > 3 %}<span> ... ({{ item.missing|length }})</span>{% endif %}
                </div>
              {% endif %}
            {% endif %}
          </div>
          {% if item.documents_complete %}
            <div class="item-status ok" title="Matriculado">✓</div>
            <span class="item-action" aria-hidden="true">Ver</span>
          {% else %}
            <div class="item-status warn" title="Pendiente">!</div>
            <span class="item-action" aria-hidden="true">Completar</span>
          {% endif %}
        </a>
        {% endwith %}
      {% endfor %}
    {% else %}
      <p style="text-align:center;color:#64748b;margin:0;">No tienes estudiantes registrados aún.</p>
    {% endif %}
  </section>

  <script>
  (function(){
    const input = document.getElementById('inst-search');
    const results = document.getElementById('inst-results');
    const modal = document.getElementById('mat-modal');
    const modalInst = document.getElementById('mat-modal-inst');
    const modalGrado = document.getElementById('mat-modal-grado');
    const modalEst = document.getElementById('mat-modal-est');
    const modalCancel = document.getElementById('mat-modal-cancel');
    const modalSend = document.getElementById('mat-modal-send');
    const suggested = document.getElementById('suggested-carousel');

    const students = [];
    {% for item in students_list %}{% with est=item.est %}students.push({id:'{{ est.id_est }}',name:'{{ est.id_usu.nom_usu }} {{ est.id_usu.ape_usu }}'});{% endwith %}{% endfor %}

    function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v? v.pop():''; }
    function renderResults(data){
      results.innerHTML='';
      if(!data.results || !data.results.length){ results.innerHTML='<p>No se encontraron instituciones.</p>'; return; }
      const grid=document.createElement('div'); grid.className='institutions-grid';
      data.results.forEach(inst=>{
        const grades = (inst.cursos||[]).map(c=>c.grd_cur).filter(Boolean);
        // Convertir "701", "1-01", "1003" en nivel principal 7, 1, 10
        const gradeLevelFromString = (s)=>{
          const digits = String(s).replace(/[^0-9]/g,'');
          if(!digits) return null;
          const n = parseInt(digits,10);
          if(isNaN(n)) return null;
          return n >= 100 ? Math.floor(n/100) : n;
        };
        const majorGrades = Array.from(new Set(grades.map(gradeLevelFromString).filter(g=>g!=null))).sort((a,b)=>a-b);
        const card=document.createElement('div'); card.className='inst-card';
        const imgHtml = inst.img ? `<img src='${inst.img}' alt='${inst.nom_inst}'>` : `<img src="{% static 'img/default_inst.png' %}" alt='${inst.nom_inst}'>`;
        const chipsHtml = majorGrades.length ? `<div class='grade-chips'>${majorGrades.map(n=>`<span class='grade-chip'>${n}º</span>`).join('')}</div>` : 'Sin cursos';
        const hasCourses = majorGrades.length > 0;
        const btnHtml = hasCourses ? `<a href='#' class='btn-matricular' data-inst-id='${inst.id_inst}' data-inst-name='${inst.nom_inst}' data-grades='${JSON.stringify(grades)}'>Matricular</a>` : `<span class='btn-matricular disabled' title='No disponible'>No disponible</span>`;
        card.innerHTML = `<div class='inst-top'><div class='inst-thumb'>${imgHtml}</div><div class='inst-texts'><h4 class='inst-name'>${inst.nom_inst}</h4><div class='inst-location'>${inst.dire_inst||''}</div></div></div><div class='inst-contact'><small>${inst.tel_inst||''} ${inst.ema_inst||''}</small></div><div class='inst-grade-summary'><strong>Grados:</strong> ${chipsHtml}</div><div class='inst-actions'>${btnHtml}</div>`;
        grid.appendChild(card);
      });
      results.appendChild(grid);
    }
    // Búsqueda en tiempo real con debounce y cancelación
    let debounceTimer=null; let pendingCtrl=null;
    function performSearch(q){
      if(pendingCtrl){ try{ pendingCtrl.abort(); }catch(e){} }
      if(!q){ results.innerHTML=''; return; }
      results.innerHTML='<p style="text-align:center;color:#64748b;">Buscando...</p>';
      pendingCtrl = new AbortController();
      fetch('{% url "school:institutions_search" %}?q='+encodeURIComponent(q),{credentials:'same-origin', signal: pendingCtrl.signal})
        .then(r=>r.json())
        .then(data=>renderResults(data))
        .catch(err=>{ if(err && err.name==='AbortError') return; results.innerHTML='<p>Error en la búsqueda.</p>'; });
    }
    input.addEventListener('input', function(){
      const q = input.value.trim();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>performSearch(q), 220);
    });

    function closeMatModal(){ modal.style.display='none'; modal.classList.remove('open'); }
    modalCancel.addEventListener('click', closeMatModal);
    function openMatricula(instName, instId, offeredGrades){
      modal.style.display='flex';
      modal.classList.add('open');
      modalInst.textContent = instName;
      modalGrado.innerHTML='';
      const gradeLevelFromString = (s)=>{
        const digits = String(s).replace(/[^0-9]/g,'');
        if(!digits) return null;
        const n = parseInt(digits,10);
        if(isNaN(n)) return null;
        return n >= 100 ? Math.floor(n/100) : n;
      };
      const unique = Array.from(new Set((offeredGrades||[]).map(gradeLevelFromString).filter(g=>g!=null))).sort((a,b)=>a-b);
      (unique.length? unique: [1,2,3,4,5,6,7,8,9,10,11]).forEach(g=>{ const o=document.createElement('option'); o.value=String(g); o.textContent=String(g); modalGrado.appendChild(o); });
      modalEst.innerHTML='';
      if(!students.length){ const o=document.createElement('option'); o.textContent='No tienes estudiantes'; modalEst.appendChild(o); }
      else students.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; modalEst.appendChild(o); });
      modal.dataset.instId = instId;
      setTimeout(()=>{ try{ modalGrado.focus(); }catch(e){} }, 60);
    }

    // Delegación para botones Matricular en carrusel y resultados
    function handleMatricularClick(e){
      const btn = e.target.closest('[data-action="matricular"], .btn-matricular');
      if(!btn) return;
      if(btn.classList.contains('disabled')) return;
      e.preventDefault();
      const instName = btn.getAttribute('data-inst-name') || btn.closest('[data-inst-name]')?.getAttribute('data-inst-name') || 'Institución';
      const instId = btn.getAttribute('data-inst-id') || btn.closest('[data-inst-id]')?.getAttribute('data-inst-id');
      let gradesRaw = btn.getAttribute('data-grades') || btn.closest('[data-grades]')?.getAttribute('data-grades') || '[]';
      let grades = [];
      try{ grades = JSON.parse(gradesRaw.replace(/'/g,'"')); }catch{ grades = []; }
      openMatricula(instName, instId, grades);
    }
    suggested.addEventListener('click', handleMatricularClick);
    results.addEventListener('click', handleMatricularClick);

    // Cerrar modal al hacer click fuera del cuadro o con Escape
    modal.addEventListener('click', function(e){ if(e.target === modal){ closeMatModal(); } });
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && modal.style.display==='flex'){ closeMatModal(); } });

    // Enviar solicitud matrícula
    let sending=false;
    modalSend.addEventListener('click',()=>{
      if(sending) return;
      const instId = modal.dataset.instId;
      const grado = modalGrado.value;
      const estId = modalEst.value;
      if(!instId || !grado || !estId){ alert('Completa los campos'); return; }
      sending=true; modalSend.disabled=true; modalSend.textContent='Enviando...';
      const fd = new FormData(); fd.append('inst_id', instId); fd.append('grado', grado); fd.append('est_id', estId);
      fetch('{% url "school:matricula_request_create" %}',{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':getCookie('csrftoken')},body:fd})
        .then(r=>r.json())
        .then(data=>{
          sending=false; modalSend.disabled=false; modalSend.textContent='Enviar solicitud';
          if(data.status==='ok'){ alert('Solicitud enviada'); closeMatModal(); }
          else { let msg=data.error||'Error'; if(data.missing){ msg+='\nFaltan: '+data.missing.join(', ');} if(data.detail){ msg+='\nDetalle: '+data.detail;} alert(msg); }
        })
        .catch(()=>{ sending=false; modalSend.disabled=false; modalSend.textContent='Enviar solicitud'; alert('Error de red'); });
    });

  })();
  </script>
{% endblock %}
