{% extends 'base_users.html' %}
{% load static %}
{% load doc_labels %}

{% block content %}
<div class="container" style="max-width:980px;margin:0 auto;">
  <div class="panel" style="background:#fff;border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,0.08);padding:18px;">
    <div class="header" style="display:flex;align-items:center;gap:14px;">
      <div class="avatar" style="width:56px;height:56px;border-radius:50%;overflow:hidden;background:#eef;display:flex;align-items:center;justify-content:center;color:#336;flex:0 0 56px;">
        {% if est.foto_perfil %}
          <img src="{{ est.foto_perfil.url }}" alt="{{ est }}" style="width:100%;height:100%;object-fit:cover;" />
        {% else %}
          <span style="font-weight:600;">{{ est|slice:":1" }}</span>
        {% endif %}
      </div>
      <div class="title">
        <h2 style="margin:0;font-size:20px;line-height:1.3;color:#223;">Documentos de {{ est }}</h2>
        <div class="chips" style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
          <span class="chip" style="background:#f5f7ff;color:#225;border:1px solid #dfe6ff;border-radius:999px;padding:4px 10px;font-size:12px;">Documento: {{ est.tip_doc_est }} {{ est.num_doc_est }}</span>
          {% if est.id_usu and est.id_usu.ema_usu %}<span class="chip" style="background:#f5f7ff;color:#225;border:1px solid #dfe6ff;border-radius:999px;padding:4px 10px;font-size:12px;">Correo: {{ est.id_usu.ema_usu }}</span>{% endif %}
          {% if est.tel_estu %}<span class="chip" style="background:#f5f7ff;color:#225;border:1px solid #dfe6ff;border-radius:999px;padding:4px 10px;font-size:12px;">Tel√©fono: {{ est.tel_estu }}</span>{% endif %}
          {% if matricula %}<span class="chip" style="background:#f5f7ff;color:#225;border:1px solid #dfe6ff;border-radius:999px;padding:4px 10px;font-size:12px;">Instituci√≥n: {{ matricula.institucion.nombre }}</span>{% endif %}
          {% if curso %}<span class="chip" style="background:#f5f7ff;color:#225;border:1px solid #dfe6ff;border-radius:999px;padding:4px 10px;font-size:12px;">Formaci√≥n: {{ curso.nombre }}</span>{% endif %}
        </div>
      </div>
    </div>

    <div style="margin-top:14px;">
      {% if documents_complete %}
        <div style="background:#e8f8ec;color:#1b6b2b;border:1px solid #c9eacc;padding:8px 12px;border-radius:8px;font-size:13px;">Documentos completos</div>
      {% else %}
        <div style="background:#fff3f3;color:#8a1f1f;border:1px solid #f0d0d0;padding:8px 12px;border-radius:8px;font-size:13px;">Faltan documentos</div>
      {% endif %}
    </div>

    <div class="docs-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
      <div class="existing-column docs-panel" style="border:1px solid #eee;border-radius:8px;padding:12px;">
        <h5 style="margin:0 0 8px 0;font-size:15px;color:#222;">Documentos existentes</h5>
        <ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;">
          {% if documento %}
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'reg_civil_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Registro civil</strong>
              {% if documento.reg_civil_doc %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.reg_civil_doc }}" target="_blank">Ver</a></span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'doc_idn_acu' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Fotocopia / foto c√©dula acudiente</strong>
              {% if documento.doc_idn_acu %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.doc_idn_acu }}" target="_blank">Ver</a></span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'doc_idn_alum' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Fotocopia / foto documento estudiante</strong>
              {% if documento.doc_idn_alum %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.doc_idn_alum }}" target="_blank">Ver</a></span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'cnt_vac_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Constancia de vacunas</strong>
              {% if documento.cnt_vac_doc %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.cnt_vac_doc }}" target="_blank">Ver</a></span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'adres_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Direcci√≥n</strong>
              {% if documento.adres_doc %}
                <span class="muted" style="margin-left:auto;font-size:12px;">{% if documento.adres_doc|slice:":1" == '/' or 'documentos/' in documento.adres_doc or '.pdf' in documento.adres_doc or '.jpg' in documento.adres_doc or '.png' in documento.adres_doc %}<a href="{{ media_url }}{{ documento.adres_doc }}" target="_blank">Ver</a>{% else %}{{ documento.adres_doc }}{% endif %}</span>
              {% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'fot_alum_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Foto alumno</strong>
              {% if documento.fot_alum_doc or est.foto_perfil %}
                <span class="muted" style="margin-left:auto;font-size:12px;"><a href="{% if documento.fot_alum_doc %}{{ media_url }}{{ documento.fot_alum_doc }}{% else %}{{ est.foto_perfil.url }}{% endif %}" target="_blank">Ver</a></span>
              {% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if documento.visa_extr_doc %}
                <span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>
              {% else %}
                <span class="muted" style="border:1px solid #ddd;border-radius:4px;padding:2px 6px;font-size:12px;">-</span>
              {% endif %}
              <strong style="margin-left:8px;">Visa (opcional)</strong>
              {% if documento.visa_extr_doc %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.visa_extr_doc }}" target="_blank">Ver</a></span>{% else %}<span class="muted" style="margin-left:auto;font-size:12px;">No cargada</span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'cer_med_disca_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Certificado m√©dico / discap.</strong>
              {% if documento.cer_med_disca_doc %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.cer_med_disca_doc }}" target="_blank">Ver</a></span>{% endif %}
            </li>
            <li style="display:flex;align-items:center;gap:8px;">
              {% if 'cer_esc_doc' in missing %}<span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span>{% else %}<span class="ok-badge" style="background:#e2f7e8;color:#207c36;border-radius:4px;padding:2px 6px;font-size:12px;">OK</span>{% endif %}
              <strong style="margin-left:8px;">Certificado escolar</strong>
              {% if documento.cer_esc_doc %}<span class="muted" style="margin-left:auto;font-size:12px;"><a href="{{ media_url }}{{ documento.cer_esc_doc }}" target="_blank">Ver</a></span>{% endif %}
            </li>
          {% else %}
            <li style="color:#666;font-size:13px;">No hay documentos subidos a√∫n.</li>
          {% endif %}
        </ul>
      </div>

      <div class="missing-column docs-panel" style="border:1px solid #eee;border-radius:8px;padding:12px;">
        <h5 style="margin:0 0 8px 0;font-size:15px;color:#222;">Documentos faltantes</h5>
        <ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;">
          {% if missing %}
            {% for m in missing %}
              <li><span class="missing-badge" style="background:#ffe5e5;color:#a22;border-radius:4px;padding:2px 6px;font-size:12px;">F</span> <strong style="margin-left:8px;">{{ m|doc_label }}</strong></li>
            {% endfor %}
          {% else %}
            <li style="color:#666;font-size:13px;">Sin documentos faltantes</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <hr style="margin:18px 0;">
    <h4 style="margin:0 0 6px 0;color:#223;">Subir documentos</h4>
    <p class="text-muted" style="margin:0 0 10px 0;color:#666;">Puedes subir documentos aunque no exista matr√≠cula; los archivos quedar√°n vinculados al estudiante.</p>

    <form method="post" enctype="multipart/form-data" id="doc-upload-form">
      {% csrf_token %}
      <div class="upload-cards" style="display:grid;grid-template-columns:1fr;gap:12px;">
        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üìÑ</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Registro civil <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">Sube el registro civil del estudiante. Haz clic o arrastra el archivo.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="reg_civil_doc" accept="image/*,.pdf" data-field="reg_civil_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="reg_civil_doc"></div>
            <div class="file-meta" data-field="reg_civil_doc"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üßæ</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Fotocopia o foto c√©dula acudiente <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">Fotocopia o fotograf√≠a de la c√©dula del acudiente responsable.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="doc_idn_acu" accept="image/*,.pdf" data-field="doc_idn_acu" style="display:none;">
            </label>
            <div class="file-preview" data-field="doc_idn_acu"></div>
            <div class="file-meta" data-field="doc_idn_acu"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üÜî</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Fotocopia o foto documento estudiante <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">Fotocopia o fotograf√≠a del documento de identidad del estudiante.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="doc_idn_alum" accept="image/*,.pdf" data-field="doc_idn_alum" style="display:none;">
            </label>
            <div class="file-preview" data-field="doc_idn_alum"></div>
            <div class="file-meta" data-field="doc_idn_alum"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üíâ</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Constancia de vacunas <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">Sube la constancia de vacunaci√≥n si aplica.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="cnt_vac_doc" accept="image/*,.pdf" data-field="cnt_vac_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="cnt_vac_doc"></div>
            <div class="file-meta" data-field="cnt_vac_doc"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">‚úèÔ∏è</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Direcci√≥n (texto) <span class="card-hint" style="font-weight:400;color:#666;">Opcional</span></div>
            <div class="card-desc" style="color:#555;">Si no tienes comprobante, escribe la direcci√≥n aqu√≠.</div>
            <input type="text" name="adres_text" value="" placeholder="Ej: Calle 123 #45-67, Barrio" class="text-input" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" />
            <div class="file-meta" data-field="adres_text"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üñºÔ∏è</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Foto alumno <span class="card-hint" style="font-weight:400;color:#666;">JPG / PNG</span></div>
            <div class="card-desc" style="color:#555;">Foto reciente del estudiante.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="fot_alum_doc" accept="image/*" data-field="fot_alum_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="fot_alum_doc"></div>
            <div class="file-meta" data-field="fot_alum_doc"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üõÇ</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Visa / Permiso extranjero <span class="card-hint" style="font-weight:400;color:#666;">Opcional</span></div>
            <div class="card-desc" style="color:#555;">Si aplica, sube el permiso o visa.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="visa_extr_doc" accept="image/*,.pdf" data-field="visa_extr_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="visa_extr_doc"></div>
            <div class="file-meta" data-field="visa_extr_doc"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">ü©∫</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Certificado m√©dico / discapacidad <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">Documentos m√©dicos relevantes.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="cer_med_disca_doc" accept="image/*,.pdf" data-field="cer_med_disca_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="cer_med_disca_doc"></div>
            <div class="file-meta" data-field="cer_med_disca_doc"></div>
          </div>
        </div>

        <div class="upload-card" style="display:flex;gap:12px;border:1px solid #eee;border-radius:8px;padding:12px;align-items:flex-start;">
          <div class="card-icon">üéì</div>
          <div class="card-main" style="flex:1;">
            <div class="card-title" style="font-weight:600;">Certificado escolar <span class="card-hint" style="font-weight:400;color:#666;">PDF / JPG</span></div>
            <div class="card-desc" style="color:#555;">√öltimo certificado acad√©mico disponible.</div>
            <label class="upload-btn" style="display:inline-block;background:#2266dd;color:#fff;padding:7px 12px;border-radius:6px;margin-top:6px;cursor:pointer;">Seleccionar archivo
              <input type="file" name="cer_esc_doc" accept="image/*,.pdf" data-field="cer_esc_doc" style="display:none;">
            </label>
            <div class="file-preview" data-field="cer_esc_doc"></div>
            <div class="file-meta" data-field="cer_esc_doc"></div>
          </div>
        </div>
      </div>

      <div class="docs-actions" style="margin-top:12px;"><button class="btn-primary" type="submit" style="background:#1e4ed8;color:#fff;border:0;border-radius:8px;padding:8px 14px;">Subir</button></div>
    </form>

    <script>
      (function(){
        const form = document.getElementById('doc-upload-form');
        if(!form) return;
        const inputs = form.querySelectorAll('input[type=file]');
        function handleFileChange(ev){
          const input = ev.currentTarget;
          const field = input.dataset.field;
          const preview = form.querySelector('.file-preview[data-field="'+field+'"]');
          const meta = form.querySelector('.file-meta[data-field="'+field+'"]');
          preview.innerHTML = '';
          meta.textContent = '';
          const file = input.files && input.files[0];
          if(!file) return;
          if(file.type && file.type.startsWith('image/')){
            const prev = preview.querySelector('img');
            if(prev && prev.dataset && prev.dataset.blobUrl){
              try{ URL.revokeObjectURL(prev.dataset.blobUrl); }catch(e){}
            }
            const img = document.createElement('img');
            const blobUrl = URL.createObjectURL(file);
            img.src = blobUrl;
            img.dataset.blobUrl = blobUrl;
            img.style.maxWidth = '140px';
            img.style.maxHeight = '110px';
            img.style.borderRadius = '4px';
            img.style.cursor = 'pointer';
            preview.appendChild(img);
          }
          meta.textContent = file.name;
          meta.classList.add('file-selected');
        }
        inputs.forEach(i => i.addEventListener('change', handleFileChange));

        const modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.innerHTML = `
          <div class="imodal-backdrop" id="imodal-backdrop"></div>
          <div class="imodal-content" role="dialog" aria-modal="true">
            <button class="imodal-close" id="imodal-close" aria-label="Cerrar">√ó</button>
            <img id="imodal-img" src="" alt="Vista previa" />
          </div>
        `;
        document.body.appendChild(modal);

        const style = document.createElement('style');
        style.textContent = `
          #image-modal { display:none; position:fixed; inset:0; z-index:1100; }
          #image-modal .imodal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.6); }
          #image-modal .imodal-content { position:relative; max-width:calc(100vw - 40px); max-height:calc(100vh - 80px); margin:40px auto; background:transparent; display:flex; align-items:center; justify-content:center; padding:12px; box-sizing:border-box; }
          #image-modal img { max-width:calc(100vw - 120px); max-height:calc(100vh - 160px); width:auto; height:auto; object-fit:contain; border-radius:6px; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
          #image-modal .imodal-close { position:absolute; left:-6px; top:-6px; background:#fff; border-radius:50%; border:0; width:34px; height:34px; font-size:20px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
        `;
        document.head.appendChild(style);

        const openModal = (src) => {
          const m = document.getElementById('image-modal');
          const im = document.getElementById('imodal-img');
          im.src = src;
          m.style.display = 'block';
          document.getElementById('imodal-close').focus();
        };
        const closeModal = () => {
          const m = document.getElementById('image-modal');
          const im = document.getElementById('imodal-img');
          im.src = '';
          m.style.display = 'none';
        };

        form.addEventListener('click', function(e){
          const img = e.target.closest('.file-preview img');
          if(img){ openModal(img.src); }
        });

        document.addEventListener('click', function(e){
          const a = e.target.closest('a');
          if(!a) return;
          const href = a.getAttribute('href') || '';
          if(/\.(jpe?g|png|gif|webp)(\?|$)/i.test(href)){
            e.preventDefault();
            openModal(href);
          }
        });

        document.getElementById('imodal-close').addEventListener('click', closeModal);
        document.getElementById('imodal-backdrop').addEventListener('click', closeModal);
        document.addEventListener('keydown', function(ev){ if(ev.key === 'Escape'){ closeModal(); } });
      })();
    </script>
  </div>
</div>
{% endblock %}
