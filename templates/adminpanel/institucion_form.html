{% extends 'base_users.html' %}
{% load static %}
{% block title %}{% if create %}Crear Institución{% else %}Editar Institución{% endif %}{% endblock %}
{% block content %}
  <div style="max-width:720px;margin:18px auto;padding:24px;background:#fff;border-radius:16px;box-shadow:0 18px 42px -12px rgba(0,0,0,0.08);">
    <h1 style="margin-top:0;text-align:center;">{% if create %}Crear Institución{% else %}Editar Institución{% endif %}</h1>
    {% if inst %}
      <p style="text-align:center;margin:-6px 0 16px 0;color:#5b6675;">Institución: <strong>{% if inst.nom_inst %}{{ inst.nom_inst }}{% elif inst.nombre %}{{ inst.nombre }}{% else %}#{{ inst.pk }}{% endif %}</strong></p>
    {% endif %}
    <form method="post" enctype="multipart/form-data">{% csrf_token %}
      <div style="margin-top:8px;">
        {{ form.as_p }}
        <div style="margin-top:14px;text-align:center;">
          {% if inst and inst.img_inst %}
            <div style="margin:8px 0 12px 0;">
              <label style="font-weight:600;display:block;margin-bottom:6px;">Logo actual</label>
              <img id="inst-current-img" src="{{ inst.img_inst.url }}" alt="Logo actual" style="max-width:240px;border-radius:12px;border:1px solid #e6e9ef;box-shadow:0 8px 22px -10px rgba(0,0,0,.18)">
            </div>
          {% endif %}
          <div id="inst-preview-wrap" style="display:none;margin:8px 0 12px 0;">
            <label style="font-weight:600;display:block;margin-bottom:6px;">Vista previa</label>
            <img id="inst-preview-img" alt="Vista previa" style="max-width:240px;border-radius:12px;border:1px solid #e6e9ef;box-shadow:0 8px 22px -10px rgba(0,0,0,.18)">
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
        <button class="btn btn-primary">{% if create %}Crear{% else %}Guardar{% endif %}</button>
        <a href="{% url 'accounts:panel_administrativo' %}" class="btn">Cancelar</a>
      </div>
    </form>
    <script>
      (function(){
        const fileInput = document.querySelector('input[type=file][name$="img_inst"]');
        const wrap = document.getElementById('inst-preview-wrap');
        const img = document.getElementById('inst-preview-img');
        const current = document.getElementById('inst-current-img');
        if(!fileInput || !wrap || !img) return;
        fileInput.addEventListener('change', function(){
          const f = this.files && this.files[0];
          if(!f){ wrap.style.display='none'; return; }
          const reader = new FileReader();
          reader.onload = function(e){ img.src = e.target.result; wrap.style.display = 'block'; };
          reader.readAsDataURL(f);
          if(current){ current.style.opacity = 0.35; }
        });
      })();
    </script>
  </div>
{% endblock %}
